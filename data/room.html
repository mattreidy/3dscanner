<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- viewport-fit=cover: extends content into iOS safe areas (notch, home indicator).
         We use env(safe-area-inset-*) in CSS to add padding where needed. -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>3DScanner Room</title>
    <link rel="stylesheet" href="/room.css">

    <!-- Import Map: tells the browser where to find ES module packages.
         Three.js is loaded from jsdelivr CDN (v0.170.0) to avoid storing
         the ~680KB library in LittleFS flash on the ESP32. This works
         because the device is on home WiFi (STA mode) with internet access.
         The "three/addons/" mapping enables importing OrbitControls and
         other Three.js examples/jsm modules with clean import paths. -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
        }
    }
    </script>
</head>
<body>
    <!-- Full-viewport WebGL canvas — Three.js renders the 3D scene here.
         Sized to 100vw x 100vh via CSS; pixel ratio handled in room.js. -->
    <canvas id="viewport"></canvas>

    <!-- ================================================================
         Control Panel — floating overlay matching the Python Viser viewer's
         folder structure. Positioned top-right on desktop, bottom drawer
         on mobile (<480px). All sections are collapsible.
         ================================================================ -->
    <div id="panel" class="panel">
        <!-- Panel header: click to collapse/expand the entire panel -->
        <div class="panel-header" id="panel-toggle">
            <span>Controls</span>
            <span class="panel-arrow">&#9660;</span>
        </div>
        <div class="panel-body">

            <!-- ======== Sensor Info ========
                 Read-only status displays updated in real-time from SSE events.
                 Matches Python viewer's "Sensor Info" folder. -->
            <div class="section">
                <div class="section-header" data-section="sensor-info">
                    <span>Sensor Info</span><span class="arrow">&#9660;</span>
                </div>
                <div class="section-body" id="sensor-info">
                    <!-- Range: shows "Range: XXX-YYYmm" from valid zones, or "No valid data" -->
                    <div class="ctrl-row">
                        <span class="ctrl-label">Status</span>
                        <span class="ctrl-value" id="info-range">--</span>
                    </div>
                    <!-- ToF data frequency computed from frame timestamps -->
                    <div class="ctrl-row">
                        <span class="ctrl-label">Frequency (Hz)</span>
                        <span class="ctrl-value" id="info-freq">--</span>
                    </div>
                    <!-- IMU connection status from BNO085 quaternion data -->
                    <div class="ctrl-row">
                        <span class="ctrl-label">IMU</span>
                        <span class="ctrl-value" id="info-imu">Not detected</span>
                    </div>
                </div>
            </div>

            <!-- ======== Settings ========
                 Matches Python viewer's "Settings" folder with identical
                 controls, ranges, defaults, and dependency behavior. -->
            <div class="section">
                <div class="section-header" data-section="settings">
                    <span>Settings</span><span class="arrow">&#9660;</span>
                </div>
                <div class="section-body" id="settings">
                    <!-- Point Size: controls THREE.PointsMaterial.size (1-20mm, default 5mm)
                         Applies to both live sensor points and accumulated map points. -->
                    <div class="ctrl-row">
                        <label for="point-size">Point Size</label>
                        <input type="range" id="point-size" min="1" max="20" step="1" value="5">
                        <span class="ctrl-val" id="point-size-val">5mm</span>
                    </div>
                    <!-- Show Zone Rays: toggles visibility of 64 blue ray lines
                         from sensor origin through each zone direction. -->
                    <div class="ctrl-row">
                        <label for="show-rays">Show Zone Rays</label>
                        <input type="checkbox" id="show-rays" checked>
                    </div>
                    <!-- Clip to Measurement: shortens rays to measured distance per zone.
                         Disabled when Show Rays is off. When unchecked, rays extend to MAX_RANGE. -->
                    <div class="ctrl-row">
                        <label for="clip-rays">Clip to Measurement</label>
                        <input type="checkbox" id="clip-rays">
                    </div>
                    <div class="separator"></div>
                    <!-- Coordinate Method: selects zone-to-3D conversion algorithm.
                         "Uniform Grid" = ideal pinhole model (uniform angular spacing).
                         "ST Lookup Table" = factory-calibrated pitch/yaw angles from VL53L5CX datasheet. -->
                    <div class="ctrl-row">
                        <label for="coord-method">Coordinate Method</label>
                        <select id="coord-method">
                            <option value="uniform" selected>Uniform Grid</option>
                            <option value="st">ST Lookup Table</option>
                        </select>
                    </div>
                    <div class="separator"></div>
                    <!-- Apply IMU Rotation: when checked, boardGroup quaternion follows BNO085 data.
                         When unchecked, boards stay at identity orientation (no rotation). -->
                    <div class="ctrl-row">
                        <label for="apply-imu">Apply IMU Rotation</label>
                        <input type="checkbox" id="apply-imu" checked>
                    </div>
                    <div class="separator"></div>
                    <!-- Enable Filtering: activates exponential moving average (EMA) temporal filter
                         on raw distance values to smooth jitter. Resets filter state on disable. -->
                    <div class="ctrl-row">
                        <label for="enable-filter">Enable Filtering</label>
                        <input type="checkbox" id="enable-filter">
                    </div>
                    <!-- Filter Strength: 0.0 = no smoothing, 1.0 = maximum smoothing.
                         EMA formula: filtered = (1-strength)*raw + strength*prev.
                         Disabled when Enable Filtering is off. -->
                    <div class="ctrl-row">
                        <label for="filter-strength">Filter Strength</label>
                        <input type="range" id="filter-strength" min="0" max="1" step="0.05" value="0.5" disabled>
                        <span class="ctrl-val" id="filter-strength-val">0.50</span>
                    </div>
                    <div class="separator"></div>
                    <!-- Fit Plane: enables least squares or RANSAC plane fitting on valid 3D points.
                         Renders a yellow semi-transparent box mesh aligned to the fitted plane. -->
                    <div class="ctrl-row">
                        <label for="fit-plane">Fit Plane</label>
                        <input type="checkbox" id="fit-plane">
                    </div>
                    <!-- Method: "Least Squares" fits z=ax+by+c via normal equations.
                         "RANSAC" uses 100 random 3-point samples for robust outlier rejection.
                         Disabled when Fit Plane is off. -->
                    <div class="ctrl-row">
                        <label for="plane-method">Method</label>
                        <select id="plane-method" disabled>
                            <option value="ls" selected>Least Squares</option>
                            <option value="ransac">RANSAC</option>
                        </select>
                    </div>
                    <!-- RANSAC Threshold: distance threshold (mm) for inlier classification.
                         Only visible when method=RANSAC and Fit Plane is on. -->
                    <div class="ctrl-row" id="ransac-row" style="display:none">
                        <label for="ransac-thresh">RANSAC Threshold (mm)</label>
                        <input type="range" id="ransac-thresh" min="1" max="50" step="1" value="10">
                        <span class="ctrl-val" id="ransac-thresh-val">10</span>
                    </div>
                    <!-- Plane RMSE: root mean square error of the fitted plane in mm -->
                    <div class="ctrl-row">
                        <span class="ctrl-label">Plane RMSE (mm)</span>
                        <span class="ctrl-value" id="plane-rmse">--</span>
                    </div>
                </div>
            </div>

            <!-- ======== Mapping ========
                 Matches Python viewer's "Mapping" folder.
                 Accumulates points in world coordinates as the device moves. -->
            <div class="section">
                <div class="section-header" data-section="mapping">
                    <span>Mapping</span><span class="arrow">&#9660;</span>
                </div>
                <div class="section-body" id="mapping">
                    <!-- Mapping Mode: when enabled, points are transformed to world coordinates
                         (including IMU rotation) and accumulated over time instead of showing
                         only the current frame's 64 live points. -->
                    <div class="ctrl-row">
                        <label for="mapping-mode">Mapping Mode</label>
                        <input type="checkbox" id="mapping-mode">
                    </div>
                    <!-- Voxel Size: grid cell size for spatial downsampling (5-50mm).
                         Smaller = higher density, larger = more aggressive deduplication. -->
                    <div class="ctrl-row">
                        <label for="voxel-size">Voxel Size (mm)</label>
                        <input type="range" id="voxel-size" min="5" max="50" step="5" value="10">
                        <span class="ctrl-val" id="voxel-size-val">10</span>
                    </div>
                    <!-- Max Points: upper limit on accumulated points (10k-500k).
                         Oldest points are dropped (FIFO) when this limit is exceeded. -->
                    <div class="ctrl-row">
                        <label for="max-points">Max Points (k)</label>
                        <input type="range" id="max-points" min="10" max="500" step="10" value="100">
                        <span class="ctrl-val" id="max-points-val">100</span>
                    </div>
                    <!-- Points: live count of accumulated map points -->
                    <div class="ctrl-row">
                        <span class="ctrl-label">Points</span>
                        <span class="ctrl-value" id="map-point-count">0</span>
                    </div>
                    <!-- Clear Map: removes all accumulated points immediately -->
                    <div class="ctrl-row">
                        <button id="btn-clear-map" class="ctrl-btn">Clear Map</button>
                    </div>
                </div>
            </div>

            <!-- ======== Navigation ======== -->
            <div class="section">
                <div class="ctrl-row nav-row">
                    <a href="/" class="nav-link">&larr; Dashboard</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Error overlay: shown if Three.js CDN fails to load (no internet access).
         Hidden by default; room.js could show this on import failure. -->
    <div id="error-overlay" class="error-overlay" style="display:none">
        <p>Failed to load Three.js from CDN.</p>
        <p>Make sure the device has internet access.</p>
    </div>

    <!-- Main application script — ES module that imports Three.js from CDN.
         Contains all 3D scene setup, SSE event handling, coordinate conversion,
         filtering, plane fitting, mapping, and UI control wiring. -->
    <script type="module" src="/room.js"></script>
</body>
</html>
